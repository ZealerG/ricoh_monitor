# 提案：理光映像 GR3X 商品监控脚本改进

## 背景

现有 `ricoh_email_monitor.py` 脚本用于监控理光映像商城（ricn-mall.com）GR3X 官翻品上新，因每秒请求一次触发反爬导致 403 Forbidden 错误而失效。需要改进脚本的健壮性和反反爬能力。

## 约束集

### 硬约束（不可违反）
1. **目标 API**: `https://newsite.ricn-mall.com/api/pc/get_products?cid=9&page=1&size=20`
2. **网站架构**: Nuxt.js（Vue SSR），API 数据通过 XHR/Fetch 获取
3. **无代理 IP**: 不使用代理池，需靠请求策略本身规避封禁
4. **监控频率**: 30 秒/次（用户确认）
5. **部署目标**: 青龙面板定时任务 + 云函数（需兼容两种环境）
6. **邮件通知**: SMTP 通过 126 邮箱发送，三个收件人
7. **关键词匹配**: 包含 "GR" 的商品名称

### 软约束（应遵循的惯例）
1. 脚本需保持单文件可执行，适配青龙面板
2. 敏感信息（密码、邮箱）通过环境变量注入
3. 日志输出适配青龙面板日志查看

### 已发现风险
1. **IP 封禁已生效**: 当前 IP 可能已在黑名单，需换 IP 或等待解封
2. **单一 User-Agent**: 原脚本 UA 过于简单（`Mozilla/5.0`），易被识别
3. **Referer 错误**: 原脚本 Referer 指向 API 地址而非页面地址
4. **无重试机制**: 请求失败直接抛异常
5. **无状态管理**: 每次运行都发邮件，无法区分"新上架"和"已通知过"
6. **密码明文**: SMTP 密码硬编码在脚本中

## 需求

### R1: 反反爬策略
- **场景**: 每 30 秒请求一次 API 不被封禁
- **方案**: 随机 User-Agent 池 + 完整浏览器 Headers + 正确 Referer + 随机延迟抖动（±5秒）
- **验证**: 连续运行 1 小时不出现 403

### R2: 错误处理与重试
- **场景**: 网络抖动、临时 403、服务器 5xx
- **方案**: 指数退避重试（最多 3 次），403 时增加冷却期
- **验证**: 临时故障后能自动恢复

### R3: 状态管理（去重通知）
- **场景**: 避免每次检测到 GR 商品都重复发邮件
- **方案**: 本地文件记录已通知商品 ID/名称，仅新增时通知
- **验证**: 同一商品不重复发送邮件

### R4: 环境变量配置
- **场景**: 敏感信息不硬编码
- **方案**: 通过 `os.environ` 读取 SMTP 配置，支持 `.env` 文件回退
- **验证**: 脚本中不包含明文密码

### R5: 云函数兼容
- **场景**: 部署到阿里云/腾讯云函数
- **方案**: 提供标准 `handler(event, context)` 入口，状态存储适配（本地文件 or 环境变量标记）
- **验证**: 可作为云函数单次调用执行

### R6: 邮件通知增强
- **场景**: 通知内容包含商品链接，便于直接抢购
- **方案**: 邮件正文附带商品详情页链接
- **验证**: 收到邮件可直接点击链接

## 成功判据

1. 脚本在新 IP 环境连续运行 1 小时无 403 错误
2. 检测到 GR 商品时 30 秒内发送邮件通知
3. 同一商品不重复通知
4. 可在青龙面板和云函数两种环境部署运行
5. 脚本中无硬编码敏感信息

## 依赖

- Python 3.8+
- requests 库
- 标准库: smtplib, email, os, json, random, time
